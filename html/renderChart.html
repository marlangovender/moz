<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Display Chart</title>
</head>
<style>
    .container {
        width: 40%;
        height: 40%;
    }
    #left {
        float: left;
        width: 50%;
        overflow: hidden;
    }
    #right {
        overflow: hidden;
    }
</style>

<body>
<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>
<!-- Dummy charts for testing.  TODO : populate with elastic data -->
<script>

    $.get("esQuery?Query={ \"aggs\" : { \"type_count\" : { \"terms\" : { \"field\" : \"Keyword.keyword\" , \"size\" : \"400\"} } } }&Size=100", function(data, status){
        var chartData = data.aggregations.type_count.buckets;
        //console.log(chartData);
        $(function () {
            $("#jsGrid").jsGrid({
                width: "100%",
                height: "500px",
                sorting: true,
                paging: true,
                data: chartData,

                fields: [
                    { name: "key", title : "Search Keys", type: "text", width: 60, validate: "required" },
                    { name: "doc_count", title: "Record Count", type: "number", width: 40, align : "center" },
                    { type: "control" }
                ],
                rowClick: function(args) {
                    renderChart(args);
                }
            });

        })

    });

    function renderChart(args) {
        var getData = args.item;
        var keys = Object.keys(getData);
        var searchKeys = getData.key;
        console.log(searchKeys);
        $.get("esQuery?Query={\"query\":{\"match_phrase\":{\"Keyword\":\""+searchKeys+"\"}}}&Size=30&Fields=[]&Sort={\"Date\":%20{\"order\":%20\"asc\"}%20}", function( data, status ) {
            //console.log(data.hits.hits);
            var dataArray = data.hits.hits;
            dataArray.sort((a, b) => (a._source.Date > b._source.Date) ? 1 : -1)
            var google=[];
            var googleBR=[];
            var yahoo=[];
            var bing=[];
            var googleEn=[];
            var googleBREn=[];
            var yahooEn=[];
            var bingEn=[];
            var dates = [];
            dataArray.forEach(function(obj){
                if (obj._source['Market']=='GB-en') {
                    console.log('Inside');
                     googleEn.push(obj._source['Google']);
                     googleBREn.push(obj._source['Google Base Rank']);
                     yahooEn.push(obj._source['Yahoo']);
                     bingEn.push(obj._source['Bing']);
                     dates.push(obj._source['Date']);
                } else {
                    google.push(obj._source['Google']);
                    googleBR.push(obj._source['Google Base Rank']);
                    yahoo.push(obj._source['Yahoo']);
                    bing.push(obj._source['Bing']);
                }
            })

            //console.log(dates);
            new Chart(document.getElementById("US"), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: "Google",
                            borderColor: "#3e95cd",
                            data: google,
                            fill: false
                        },
                        {
                            label: "Google Base Rank",
                            borderColor: "#8e5ea2",
                            data: googleBR,
                            fill: false
                        },
                        {
                            label: "Bing",
                            borderColor: "#3cba9f",
                            data: bing,
                            fill: false
                        },
                        {
                            label: "Yahoo",
                            borderColor: "#e8c3b9",
                            data: yahoo,
                            fill: false
                        }
                    ]
                },
                options: {
                    legend: {display: true},
                    title: {
                        display: true,
                        text: 'Moz Search Analytics (US) - ' + searchKeys
                    }
                }
            });
            new Chart(document.getElementById("GB"), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: "Google",
                            borderColor: "#3e95cd",
                            data: googleEn,
                            fill: false
                        },
                        {
                            label: "Google Base Rank",
                            borderColor: "#8e5ea2",
                            data: googleBREn,
                            fill: false
                        },
                        {
                            label: "Bing",
                            borderColor: "#3cba9f",
                            data: bingEn,
                            fill: false
                        },
                        {
                            label: "Yahoo",
                            borderColor: "#e8c3b9",
                            data: yahooEn,
                            fill: false
                        }
                    ]
                },
                options: {
                    legend: {display: true},
                    title: {
                        display: true,
                        text: 'Moz Search Analytics (GB) - '+ searchKeys
                    }
                }
            });
        });
    }

</script>

<div id="wrapper">
    <div id="jsGrid"></div>
    <div id="left"><canvas id="US" ></canvas></div>
    <div id="right"><canvas id="GB" ></canvas></div>
</div>

</body>
</html>